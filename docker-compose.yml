# Simplified Docker Compose for Local Development
# Run Next.js on HOST, Convex Backend + Dashboard + MailHog in Docker

services:
  # Convex Backend - Self-hosted Convex instance
  convex-backend:
    image: ghcr.io/get-convex/convex-backend:latest
    container_name: convex-backend
    ports:
      - "3210:3210"  # Convex API (accessible from host)
      - "3211:3211"  # HTTP Actions (accessible from host)
    volumes:
      - convex-data:/convex/data
    environment:
      # Instance name (auto-persisted)
      - INSTANCE_NAME=${INSTANCE_NAME:-convex-self-hosted}
      
      # Backend URLs (how clients access it)
      - CONVEX_CLOUD_ORIGIN=${CONVEX_CLOUD_ORIGIN:-http://localhost:3210}
      - CONVEX_SITE_ORIGIN=${CONVEX_SITE_ORIGIN:-http://localhost:3211}
      
      # Optional: Disable telemetry
      - DISABLE_BEACON=1
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3210"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # Convex Dashboard - Web UI for managing backend
  convex-dashboard:
    image: ghcr.io/get-convex/convex-dashboard:latest
    container_name: convex-dashboard
    ports:
      - "6791:6791"
    environment:
      - NEXT_PUBLIC_DEPLOYMENT_URL=${NEXT_PUBLIC_DEPLOYMENT_URL:-http://localhost:3210}
    depends_on:
      convex-backend:
        condition: service_healthy
    restart: unless-stopped

  # MailHog - Email testing (SMTP server + web UI)
  mailhog:
    image: mailhog/mailhog:latest
    container_name: mailhog
    ports:
      - "1025:1025"  # SMTP server
      - "8025:8025"  # Web UI
    environment:
      - MH_STORAGE=memory
    restart: unless-stopped

volumes:
  convex-data:
    driver: local
